<!DOCTYPE html>
<html lang="it">

<head th:replace="~{fragments/header :: header(title='SiwFood - Modifica Ricetta')}">
	<style>
		.image-container img {
			width: 100%;
			object-fit: cover;
			max-height: 200px;
			min-height: 200px;
		}
	</style>
</head>

<body
	style="background: #e6e2dc; background-image: url('/images/sfondo.jpeg'); background-size: cover; background-repeat: no-repeat; background-attachment: fixed;">
	<!-- Include la navbar -->
	<div th:replace="~{fragments/navbar :: navbar}"></div>

	<div class="container form-container mt-5 mb-5">
		<h2 class="text-center mb-4"
			style="background-color: #3d5048; color: white; padding: 10px; border-radius: 5px;">Modifica Ricetta</h2>
		<form th:action="@{/update/ricetta/{id}(id=${ricetta.id})}" method="post" enctype="multipart/form-data">
			<div class="row">
				<!-- Colonna Ingredienti -->
				<div class="col-md-4">
					<div id="ingredienti-section">
						<!-- Visualizza le righe ricetta esistenti -->
						<div th:each="rigaRicetta : ${ricetta.righeRicetta}"
							class="row align-items-center mb-2 ingredienti-group">
							<div class="col-md-6">
								<select class="form-control" name="ingredientiIds">
									<option th:each="ing : ${ingredienti}" th:value="${ing.id}" th:text="${ing.nome}"
										th:selected="${ing.id == rigaRicetta.ingrediente.id}"></option>
								</select>
							</div>
							<div class="col-md-4">
								<input type="text" class="form-control" name="quantita"
									th:value="${rigaRicetta.quantita}" placeholder="Quantità">
							</div>
							<div class="col-md-1 p-0">
								<button type="button" class="btn btn-danger remove-ingrediente">
									<img src="/images/differenza.svg" alt="Remove" style="filter: invert(1);">
								</button>
							</div>
						</div>
						<!-- Template per aggiungere nuovi ingredienti -->
						<template id="ingredient-template">
							<div class="row align-items-center mb-2 ingredienti-group">
								<div class="col-md-6">
									<select class="form-control" name="ingredientiIds" required>
										<option th:each="ing : ${ingredienti}" th:value="${ing.id}"
											th:text="${ing.nome}">Ingrediente</option>
									</select>
								</div>
								<div class="col-md-4">
									<input type="text" class="form-control" name="quantita" placeholder="Quantità">
								</div>
								<div class="col-md-1 p-0">
									<button type="button" class="btn btn-danger remove-ingrediente">
										<img src="/images/differenza.svg" alt="Remove" style="filter: invert(1);">
									</button>
								</div>
							</div>
						</template>
					</div>
					<div class="d-flex justify-content-center">
						<button type="button" class="btn btn-primary mb-3" id="add-ingrediente" style="border: none; background: none; padding: 0;">
							<img src="/images/somma.svg" alt="Aggiungi" style="border-radius: 50%; width: 40px; height: 40px;">
						</button>
					</div>
					<div class="d-flex justify-content-center">
						<p class="mb-3" style="color: black;">Se mancano degli ingredienti, torna indietro e aggiungili
							prima di continuare...</p>
					</div>
				</div>
				<!-- Divisore verticale -->
				<div class="col-md-1 d-flex justify-content-center align-items-center"
					style="flex: 0 0 2%; max-width: 2%;">
					<div style="border-left: 1px solid rgba(0, 0, 0, 0.1); height: 100%;"></div>
				</div>

				<!-- Colonna Modifica Ricetta -->
				<div class="col-md-4">
					<div class="md-3">
						<label for="nome" class="form-label">Nome:</label>
						<input type="text" class="form-control" id="nome" name="nome" th:value="${ricetta.nome}"
							required>
					</div>
					<div class="md-4">
						<label for="fileImages" class="form-label">Carica immagine della ricetta:</label>
						<input type="file" class="form-control" id="fileImages" name="fileImages" accept="image/*"
							multiple onchange="loadFiles(event)">
					</div>
					<div class="md-3">
						<label for="descrizione" class="form-label">Descrizione:</label>
						<textarea class="form-control" id="descrizione" name="descrizione" rows="5" required
							th:text="${ricetta.descrizione}"></textarea>
					</div>
				</div>
				<!-- Divisore verticale -->
				<div class="col-md-1 d-flex justify-content-center align-items-center"
					style="flex: 0 0 2%; max-width: 2%;">
					<div style="border-left: 1px solid rgba(0, 0, 0, 0.1); height: 100%;"></div>
				</div>


				<!-- Colonna Immagini attuali -->
				<div class="col-md-3">
					<div class="card mb-4" style="width: 100%; margin: 0 auto;">
						<div class="card-body p-0">
							<!-- Display all images without carousel -->
							<div id="ricettaImages" class="image-container">
								<div th:each="urlImage : ${ricetta.urlsImages}">
									<img th:src="${urlImage}" class="d-block w-100" alt="Immagine Ricetta" />
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div style="position: relative;">
				<button type="submit" style="position: absolute; bottom: 10px; left: 10px; width: 20px; height: 20px; background-color: #28a745; border: none; border-radius: 4px; color: white; font-size: 10px; display: flex; align-items: center; justify-content: center;">✔</button>
			</div>
		</form>
	</div>

	<!-- Include il footer -->
	<div th:replace="~{fragments/footer :: footer}"></div>

	<!-- Script per la preview delle nuove immagini e la gestione degli ingredienti -->
	<script>
		function loadFiles(event) {
			const files = event.target.files;
			const imageContainer = document.getElementById('ricettaImages');
			imageContainer.innerHTML = '';

			for (let i = 0; i < files.length; i++) {
				const reader = new FileReader();
				reader.onload = function (e) {
					const img = document.createElement('img');
					img.src = e.target.result;
					img.className = 'd-block w-100';
					img.alt = `Immagine Ricetta ${i + 1}`;
					imageContainer.appendChild(img);
				};
				reader.readAsDataURL(files[i]);
			}
		}

		document.getElementById('add-ingrediente').addEventListener('click', function () {
			const template = document.getElementById('ingredient-template').content.cloneNode(true);
			const section = document.getElementById('ingredienti-section');

			// Conta gli elementi attuali per determinare il nuovo indice
			const newIndex = section.getElementsByClassName('ingredienti-group').length;

			// Sostituisci il placeholder __index__ con il nuovo indice
			const newGroup = template.querySelector('.ingredienti-group');
			newGroup.innerHTML = newGroup.innerHTML.replace(/__index__/g, newIndex);

			section.appendChild(template);
		});

		document.addEventListener('click', function (e) {
			if (e.target && e.target.classList.contains('remove-ingrediente')) {
				e.target.closest('.ingredienti-group').remove();
			}
		});
	</script>
</body>

</html>
